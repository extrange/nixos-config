# My NixOS Configuration

https://github.com/extrange/nixos-config/assets/29305375/d6c1ed13-6e20-4f08-81ee-dac268ea39cf

Each host has 3 files:

- home.nix
- system.nix
- hardware-configuration.nix (generated by `nixos-generate-config`)

An encrypted root + swap ([LVM over LUKS]) will be setup by default.

## Install

> [!IMPORTANT]
> Before installing anything, you will need to back up your existing configuration:
>
> - Firefox profile directory
> - `/etc/fstab` (if applicable)
> - `nm-cli` connections (if applicable)
> - VM images (if applicable)

Boot into the NixOS [installer].

```text
$ sudo -i
# source <(curl -s https://raw.githubusercontent.com/extrange/nixos-config/main/setup.sh)
```

Enter SSH login details when prompted.

Reboot.

## Post Install

- Pull Firefox profile
- Login to `git`
- `git push` changes to `hardware-configuration.nix`
- Setup logins (these can't be declaratively set yet)
  - Tailscale
  - Telegram
  - Whatsapp
- Syncthing: configure folders, add device to server
- GSConnect pairing

## Notes

- To edit `sops` secrets, use `SOPS_AGE_KEY=$(ssh-to-age -private-key -i ~/.ssh/id_ed25519) sops secrets.yaml`.
- To add a new key for a host:
  - First, get the `age` key from the SSH public key: `ssh-keygen -y -f path/to/public/key | ssh-to-age`
  - Update: `SOPS_AGE_KEY=$(ssh-to-age -private-key -i path/to/private/key sops updatekeys secrets.yaml` (the private key must have previously used to encrypt the file)
- `nixos-rebuild switch --flake .#hostname` will not allow access to untracked files. To [work around] this, do `nixos-rebuild switch --flake path:.#hostname`.
- Using `read` in `curl ... | bash` doesn't work as `read` does not have access to the terminal, so `source` is used instead.

## Resources

- Dotfiles: [dmadisetti], [Electrostasy], [reckenrode]
- Hyprland configs: [yurihikari], [Waayway]
- [Handling Secrets in NixOS][secrets]

[secrets]: https://lgug2z.com/articles/handling-secrets-in-nixos-an-overview/
[NixOps]: https://christine.website/blog/nixos-encrypted-secrets-2021-01-20/
[Waayway]: https://github.com/Waayway/hyprland-waayway
[yurihikari]: https://github.com/yurihikari/garuda-sway-config
[electrostasy]: https://github.com/Electrostasy/dots
[reckenrode]: https://github.com/reckenrode/nixos-configs
[dmadisetti]: https://github.com/dmadisetti/.dots
[work around]: https://discourse.nixos.org/t/dirty-nixos-rebuild-build-flake-issues/30078/2
[LVM over LUKS]: https://wiki.archlinux.org/title/dm-crypt/Encrypting_an_entire_system#LVM_on_LUKS
[installer]: https://channels.nixos.org/nixos-23.11/latest-nixos-minimal-x86_64-linux.iso
